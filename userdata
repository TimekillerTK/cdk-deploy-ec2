# shebang is added automatically by deploy_ec2.py
# install docker & other packages
yum install docker nmap jq -y

# Docker compose can also be installed with pip, but the one on amazon linux 2 is version v1.29, whereas newest one is v2+
curl -L https://github.com/docker/compose/releases/download/v2.5.1/docker-compose-$(uname -s)-$(uname -m) -o /usr/local/bin/docker-compose && chmod a+x /usr/local/bin/docker-compose

# Adds ec2-user to docker users
usermod -aG docker ec2-user

# Enables automatic startup & starts docker daemon
systemctl enable docker && systemctl start docker

# copies contents of S3 bucket & puts bucket name as an environment variable
BUCKET_NAME=$(aws ssm get-parameter --name /cdk-deploy-ec2/s3bucketname --region us-east-1 | jq -r '.Parameter.Value')
echo "export BUCKET_NAME=${BUCKET_NAME}" >> .bashrc 
mkdir /home/ec2-user/docker && aws s3 cp --recursive s3://${BUCKET_NAME} /home/ec2-user/docker && chown -R ec2-user:ec2-user /home/ec2-user/*